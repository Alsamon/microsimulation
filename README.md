*[work-in-progress]*

# microsimulation
Static and dynamic, population and household, microsimulation models. Take a base population and project it forward using various methodologies.

Current status:
- [X] static population microsimulation: refinement/testing
- [ ] dynamic population microsimulation: in prototype, reimplementation in progress
- [X] quasi-dynamic househould microsimulation: basic model
- [X] population-househould assignment algorithm : basic implementation
- [ ] coupled dynamic household-population microsimulation: drawing board

## Explanation of terms
- microsynthesis: generating a synthetic population from aggregate (categorical) data and (usually) joint distribution data
- microsimulation: evolving a (microsynthesised) population forward in time
- static: in this context, this means generating a synthetic population using estimated aggregate data, and a microsynthesis as a joint distribution
- dynamic: in this context, this means evolving each entity as a dynamic progress, typically probabilistically. E.g. using Monte-Carlo and fertility/mortality/migration rates.
- quasi-dynamic: in this context, a simplistic evolution whereby existing entities persist according to a survival probability and new entities are created to match a static estimate. 

## Introduction
### Static Microsimulation - Population
This refers to a sequence of microsyntheses, seeded with 2011 census data, with marginals from ONS mid-year-estimates (2001-2013) and ONS sub-national population projections (2014-2039).
- limited categories available: gender, age, ethnicity.
- highest geographical resolution is currently limited to MSOA (census tables with single year of age are not available at a lower resolution)

### Static Microsimulation - Households
This refers to a sequence of microsyntheses, seeded with microsynthesised data, with overall counts coming from DCLG household forcasts (1991-2039).
- microsynthesised data is generated by the upstream household_microsynthesis model, at OA resolution in ~10 categoriacl varaibles.
- Projection model is currently crude: simply samples the base population until the desired total population is achieved.

### Dynamic Microsimulation
This refers to a stochastic simulation of individual elements (persons or households) in time using a Monte-Carlo approach.
Based on provided fertility, mortality and migration data and guided by static microsimulation above.

## Setup

### Dependencies

- `python3`

The following packages are specified in `requirements.txt` and should be automatically installed, manual steps are shown below just in case. 

- [UKCensusAPI](https://github.com/virgesmith/UKCensusAPI): wrapper around the nomisweb API for census data
```
pip3 install git+git://github.com/virgesmith/UKCensusAPI.git
```

- [population](https://github.com/nismod/population): wrapper around national and subnational population projection data
```
pip3 install git+git://github.com/nismod/population.git
```

- [humanleague](https://github.com/virgesmith/humanleague): microsynthesis package
```
pip3 install git+git://github.com/virgesmith/humanleague.git
```
NB Ensure you install humanleague version 2 or higher - this package uses features that are not available in earlier versions.

### Installation and Testing
The UKCensusAPI package requires an API key to function correctly, see [here](http://github.com/virgesmith/UKCensusAPI/README.md) for details 

```
./setup.py install
./setup.py test
```
### Running a static population microsimulation
```bash
$ scripts/run_ssm.py --help
usage: run_ssm.py [-h] [-c config-file] LAD [LAD ...]

static sequential (population/household) microsimulation

positional arguments:
  LAD                   ONS code for LAD (multiple LADs can be set).

optional arguments:
  -h, --help            show this help message and exit
  -c config-file, --config config-file
                        the model configuration file (json). See
                        config/*_example.json
```
where config-file is a JSON file containing the model parameters and settings. Examples can be found in the config subdirectory of this package.
```json
{
  "resolution": "MSOA11",
  "projection": "ppp",
  "census_ref_year": 2011,
  "projection_ref_year": 2014,
  "horizon_year": 2039,
  "mode": "fast",
  "cache_dir": "./cache",
  "output_dir": "./data"
}
```
### Running a household microsimulation
```
$ scripts/run_ssm_h.py --help
usage: run_ssm_h.py [-h] [-c config-file] LAD [LAD ...]

static sequential (population/household) microsimulation

positional arguments:
  LAD                   ONS code for LAD (multiple LADs can be set).

optional arguments:
  -h, --help            show this help message and exit
  -c config-file, --config config-file
                        the model configuration file (json). See
                        config/*_example.json`
```                        
                        
                     
where config-file is a JSON file containing the model parameters and settings. Examples can be found in the config subdirectory of this package.
```json
{
  "resolution": "OA11",
  "projection": "ppp",
  "census_ref_year": 2011,
  "projection_ref_year": 2014,
  "horizon_year": 2020,
  "upstream_dir": "../household_microsynth/data",
  "input_dir": "./persistent_data",
  "output_dir": "./data"
}
```


### Running dynamic population microsimulation

```
scripts/run_microsynth.py E09000001 MSOA11 2001 2039
```
NB Runtime for a medium-sized local authority for all 39 years is likely to be well over 24h.

### Running the assignment (people->households) algorithm
TODO

